<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My DDL Wall ğŸ“Œ</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Kalam:wght@300;400;700&family=Noto+Sans+SC:wght@400;700&family=Patrick+Hand&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="lang-switch">
        <button class="lang-btn" onclick="toggleLanguage()">
            <span id="langText">English</span>
        </button>
    </div>

    <div class="container">
        <div class="header">
            <h1 id="mainTitle">ğŸ“Œ DDLs & Notes ğŸ“Œ</h1>
            <p id="subtitle">ç›´æ¥åœ¨å¢™ä¸Šè®°å½•ä½ çš„çµæ„Ÿä¸æœŸé™</p>
        </div>

        <button class="floating-add-btn show" id="floatingBtn" onclick="toggleAddNote()">
            <span id="addIcon">â•</span>
        </button>

        <div class="filter-section">
            <button class="filter-btn active" onclick="filterItems('all')" id="filterAll">All</button>
            <button class="filter-btn" onclick="filterItems('ddl')" id="filterDdl">ğŸ—“ï¸ DDL</button>
            <button class="filter-btn" onclick="filterItems('note')" id="filterNote">ğŸ“ Notes </button>
            <button class="filter-btn" onclick="filterItems('high')" id="filterHigh">ğŸ”¥ Urgent</button>
        </div>

        <div id="notesContainer" class="notes-container">
        </div>

        <div id="emptyState" class="empty-state">
            <div class="empty-state-icon">ğŸ“­</div>
            <h2 id="emptyTitle">å¢™ä¸Šè¿˜ç©ºç©ºå¦‚ä¹Ÿ</h2>
            <p id="emptyText">ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªä¾¿ç­¾å§ï¼</p>
        </div>
    </div>

    <script>
        let items = JSON.parse(localStorage.getItem('ddlItems')) || [];
        let currentFilter = 'all';
        let currentLang = localStorage.getItem('language') || 'zh';
        let editingItemId = null;
        let isAdding = false;

        let draggedNote = null;
        let dragOffset = { x: 0, y: 0 };

        let maxZIndex = items.length > 0 ? Math.max(...items.map(i => i.zIndex || 10)) : 10;

        const translations = {
            zh: {
                mainTitle: 'ğŸ“Œ æˆ‘çš„DDLå¢™ ğŸ“Œ',
                subtitle: 'ç›´æ¥åœ¨å¢™ä¸Šè®°å½•ä½ çš„çµæ„Ÿä¸æœŸé™',
                langBtn: 'English',
                placeholderTitle: 'æ ‡é¢˜...',
                placeholderDesc: 'æ·»åŠ æè¿°...',
                btnSave: 'ç¡®è®¤',
                btnCancel: 'å–æ¶ˆ',
                btnEdit: 'ç¼–è¾‘',
                btnDelete: 'åˆ é™¤',
                typeDdl: 'DDL',
                typeNote: 'ä¾¿ç­¾',
                expired: 'â° å·²è¿‡æœŸ',
                daysLeft: 'è¿˜æœ‰ {0} å¤©',
                hoursLeft: 'âš ï¸ {0} å¤© {1} å°æ—¶',
                minutesLeft: 'ğŸ”¥ {0} å°æ—¶ {1} åˆ†é’Ÿ',
                urgentMinutes: 'ğŸ”¥ğŸ”¥ è¿˜æœ‰ {0} åˆ†ï¼',
                emptyTitle: 'å¢™ä¸Šè¿˜ç©ºç©ºå¦‚ä¹Ÿ',
                emptyText: 'ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªä¾¿ç­¾å§ï¼',
                priorityHigh: 'ç´§æ€¥', priorityMedium: 'ä¸€èˆ¬', priorityLow: 'ä¸æ€¥',
            },
            en: {
                mainTitle: 'ğŸ“Œ My DDL Wall ğŸ“Œ',
                subtitle: 'Pin notes and deadlines directly on the wall',
                langBtn: 'ä¸­æ–‡',
                placeholderTitle: 'Title...',
                placeholderDesc: 'Details...',
                btnSave: 'Save',
                btnCancel: 'Cancel',
                btnEdit: 'Edit',
                btnDelete: 'Delete',
                typeDdl: 'DDL',
                typeNote: 'Note',
                expired: 'â° Expired',
                daysLeft: '{0} days left',
                hoursLeft: 'âš ï¸ {0}d {1}h left',
                minutesLeft: 'ğŸ”¥ {0}h {1}m left',
                urgentMinutes: 'ğŸ”¥ğŸ”¥ {0}m left!',
                emptyTitle: 'Your wall is empty',
                emptyText: 'Click the button to add your first note!',
                priorityHigh: 'Urgent', priorityMedium: 'Normal', priorityLow: 'Low',
            }
        };

        function t(key, ...args) {
            let text = translations[currentLang][key] || key;
            args.forEach((arg, i) => { text = text.replace(`{${i}}`, arg); });
            return text;
        }

        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            localStorage.setItem('language', currentLang);
            updateUI();
            renderItems();
        }

        function updateUI() {
            document.getElementById('mainTitle').textContent = t('mainTitle');
            document.getElementById('subtitle').textContent = t('subtitle');
            document.getElementById('langText').textContent = t('langBtn');
            document.getElementById('emptyTitle').textContent = t('emptyTitle');
            document.getElementById('emptyText').textContent = t('emptyText');
        }

        function toggleAddNote() {
            if (isAdding) return;
            isAdding = true;
            editingItemId = null;
            renderItems();
        }

        function cancelAction() {
            isAdding = false;
            editingItemId = null;
            renderItems();
        }

        function enterEditMode(id) {
            isAdding = false;
            editingItemId = id;
            bringToFront(id);
            renderItems();
        }

        function bringToFront(id) {
            maxZIndex++;
            const item = items.find(i => i.id === id);
            if (item) {
                item.zIndex = maxZIndex;
                const el = document.querySelector(`[data-id="${id}"]`);
                if (el) el.style.zIndex = maxZIndex;
            }
        }
        function toggleTask(event, itemId, text, isCurrentlyChecked) {
            // 1. é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘å¡ç‰‡çš„ mousedown (æ‹–æ‹½/ç½®é¡¶)
            event.stopPropagation();

            const item = items.find(i => i.id === itemId);
            if (!item) return;

            const oldTask = isCurrentlyChecked ? `[x]${text}` : `[ ]${text}`;
            const newTask = isCurrentlyChecked ? `[ ]${text}` : `[x]${text}`;
            item.description = item.description.replace(oldTask, newTask);

            localStorage.setItem('ddlItems', JSON.stringify(items));

            const checkbox = event.target;
            const lineContainer = checkbox.closest('.checkbox-line');

            if (isCurrentlyChecked) {
                lineContainer.classList.remove('completed-task');
                checkbox.setAttribute('onclick', `toggleTask(event, ${itemId}, '${text}', false)`);
            } else {
                lineContainer.classList.add('completed-task');
                checkbox.setAttribute('onclick', `toggleTask(event, ${itemId}, '${text}', true)`);
            }
        }
        function saveNote(id) {
            const card = document.querySelector(`[data-id="${id || 'new'}"]`);
            const title = card.querySelector('.input-title').value;
            const description = card.querySelector('.input-desc').value;
            const priority = card.querySelector('.input-priority').value;
            const deadline = card.querySelector('.input-deadline')?.value; // è·å–æ—¶é—´é€‰æ‹©æ¡†çš„å€¼
            const color = card.style.backgroundColor;

            if (!title) return alert("Please enter a title!");

            if (id) {
                const item = items.find(i => i.id === id);
                item.title = title;
                item.description = description;
                item.priority = priority;
                item.color = color;
                item.deadline = deadline;
                item.type = deadline ? 'ddl' : 'note';
            } else {
                maxZIndex++;
                items.unshift({
                    id: Date.now(),
                    type: deadline ? 'ddl' : 'note',
                    title, description, priority, color,
                    deadline,
                    createdAt: new Date().toISOString(),
                    zIndex: maxZIndex,
                    position: { x: 100, y: 100 }
                });
            }

            localStorage.setItem('ddlItems', JSON.stringify(items));
            isAdding = false;
            editingItemId = null;
            renderItems();
        }
        function deleteItem(id) {
            if (confirm("Delete this note?")) {
                items = items.filter(item => item.id !== id);
                localStorage.setItem('ddlItems', JSON.stringify(items));
                renderItems();
            }
        }

        function startDrag(e, id) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'BUTTON' || e.target.tagName === 'SELECT') return;

            const card = e.currentTarget;
            draggedNote = { id, element: card };

            bringToFront(id);

            // maxZIndex++;
            // card.style.zIndex = maxZIndex;
            // const item = items.find(i => i.id === id);
            // if (item) item.zIndex = maxZIndex;

            card.classList.add('dragging');
            const rect = card.getBoundingClientRect();
            const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
            dragOffset.x = clientX - rect.left;
            dragOffset.y = clientY - rect.top;
        }

        document.addEventListener('mousemove', (e) => {
            if (!draggedNote) return;
            const clientX = e.clientX;
            const clientY = e.clientY;
            const container = document.getElementById('notesContainer');
            const rect = container.getBoundingClientRect();

            let x = clientX - rect.left - dragOffset.x;
            let y = clientY - rect.top - dragOffset.y;

            draggedNote.element.style.left = x + 'px';
            draggedNote.element.style.top = y + 'px';
        });

        document.addEventListener('mouseup', () => {
            if (!draggedNote) return;
            draggedNote.element.classList.remove('dragging');
            const item = items.find(i => i.id === draggedNote.id);
            if (item) {
                item.position = {
                    x: parseInt(draggedNote.element.style.left),
                    y: parseInt(draggedNote.element.style.top)
                };
                localStorage.setItem('ddlItems', JSON.stringify(items));
            }
            draggedNote = null;
        });

        function renderItems() {
            const container = document.getElementById('notesContainer');
            const emptyState = document.getElementById('emptyState');
            let filteredItems = items;

            if (currentFilter !== 'all') {
                filteredItems = items.filter(i => i.type === currentFilter || i.priority === currentFilter);
            }

            if (filteredItems.length === 0 && !isAdding) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            emptyState.style.display = 'none';

            let html = '';

            // å¦‚æœæ­£åœ¨æ·»åŠ ï¼Œå…ˆæ¸²æŸ“ä¸€ä¸ª"è‰ç¨¿ä¾¿ç­¾"
            if (isAdding) {
                html += renderEditCard(null);
            }

            filteredItems.forEach(item => {
                if (editingItemId === item.id) {
                    html += renderEditCard(item);
                } else {
                    html += renderViewCard(item);
                }
            });

            container.innerHTML = html;
        }

        function renderViewCard(item) {
            const countdown = item.type === 'ddl' ? getCountdown(item.deadline) : null;
            const pos = item.position || { x: 50, y: 50 };
            const zIndex = item.zIndex || 100;

            // Process description to handle checkboxes and line breaks
            let processedContent = (item.description || '')
                .replace(/\[ \](.*)/g, '<div class="checkbox-line"><input type="checkbox" class="note-checkbox" onclick="toggleTask(event, ${item.id}, \'$1\', false)"> $1</div>')
                .replace(/\[x\](.*)/g, '<div class="checkbox-line completed-task"><input type="checkbox" class="note-checkbox" checked onclick="toggleTask(event, ${item.id}, \'$1\', true)"> $1</div>');

            // Use a template literal fix for the onclick IDs
            processedContent = processedContent.split('${item.id}').join(item.id);

            return `
        <div class="note-card" data-id="${item.id}"
             style="background: ${item.color}; left: ${pos.x}px; top: ${pos.y}px; z-index: ${zIndex};"
             onmousedown="startDrag(event, ${item.id})">
            <div class="note-header">
                <div class="note-title">${item.title}</div>
                <span class="priority-badge priority-${item.priority}">${t('priority' + item.priority.charAt(0).toUpperCase() + item.priority.slice(1))}</span>
            </div>
            ${countdown ? `<div class="countdown ${countdown.class}">${countdown.text}</div>` : ''}
            <div class="note-content">${processedContent}</div>
            <div class="note-footer">
                <span class="note-type">${item.type === 'ddl' ? 'ğŸ“… DDL' : 'ğŸ“'}</span>
                <div class="note-actions">
                    <button class="edit-btn" onclick="enterEditMode(${item.id})">âœï¸</button>
                    <button class="delete-btn" onclick="deleteItem(${item.id})">ğŸ—‘ï¸</button>
                </div>
            </div>
        </div>
    `;
        }

        function renderEditCard(item) {
            const isNew = !item;
            const title = isNew ? '' : item.title;
            const desc = isNew ? '' : item.description;
            const priority = isNew ? 'medium' : item.priority;
            const color = isNew ? '#ffd4b8' : item.color;
            const deadline = isNew ? '' : (item.deadline || '');
            const pos = isNew ? { x: 100, y: 100 } : item.position;
            const zIndex = isNew ? 9999 : (item.zIndex || 9999); // ç¼–è¾‘ä¸­çš„ä¾¿ç­¾æ€»æ˜¯å¾ˆé«˜

            return `
        <div class="note-card editing" data-id="${isNew ? 'new' : item.id}"
             style="background: ${color}; left: ${pos.x}px; top: ${pos.y}px; z-index: ${zIndex};">
            <input type="text" class="input-title" placeholder="${t('placeholderTitle')}" value="${title}">
            <textarea class="input-desc" placeholder="${t('placeholderDesc')}">${desc}</textarea>
            <div class="edit-controls">
                <select class="input-priority">
                    <option value="high" ${priority === 'high' ? 'selected' : ''}>ğŸ”¥ ${t('priorityHigh')}</option>
                    <option value="medium" ${priority === 'medium' ? 'selected' : ''}>âš ï¸ ${t('priorityMedium')}</option>
                    <option value="low" ${priority === 'low' ? 'selected' : ''}>âœ… ${t('priorityLow')}</option>
                </select>
                <input type="datetime-local" class="input-deadline" value="${deadline}">
            </div>
            <div class="color-row">
                ${['#ffd4b8', '#ffb8c6', '#c8f0d4', '#e0d4ff', '#c8e4ff', '#fff9c4'].map(c =>
                `<div class="color-dot ${color === c ? 'active' : ''}" style="background:${c}" onclick="this.parentElement.parentElement.style.background='${c}'"></div>`
            ).join('')}
            </div>
            <div class="note-footer">
                <button class="cancel-btn" onclick="cancelAction()">${t('btnCancel')}</button>
                <button class="save-btn" onclick="saveNote(${isNew ? null : item.id})">${t('btnSave')}</button>
            </div>
        </div>
    `;
        }
        function getCountdown(deadline) {
            const diff = new Date(deadline) - new Date();
            if (diff < 0) return { text: t('expired'), class: '' };
            const days = Math.floor(diff / 86400000);
            const hours = Math.floor((diff % 86400000) / 3600000);
            if (days > 7) return { text: t('daysLeft', days), class: 'safe' };
            if (days > 0) return { text: t('hoursLeft', days, hours), class: 'warning' };
            return { text: t('urgentMinutes', Math.floor(diff / 60000)), class: '' };
        }

        function filterItems(f) {
            currentFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderItems();
        }

        updateUI();
        renderItems();
    </script>
</body>

</html>